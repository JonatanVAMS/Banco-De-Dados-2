@model CinemaManager.ViewModels.PurchaseViewModel

@{
    // Define o título da página baseado no perfil do usuário
    ViewData["Title"] = User.IsInRole("Cliente") ? "Comprar Ingresso" : "Vender Ingresso";
}

<style>
    /* Estilos para o mapa de assentos */
    .assento {
        width: 45px;
        height: 40px;
        margin: 4px;
        font-size: 0.75rem;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        font-weight: bold;
        transition: all 0.2s;
    }

    .assento-selecionado {
        background-color: #0d6efd !important;
        color: white;
        border-width: 2px;
        transform: scale(1.1);
    }

    .assento-ocupado {
        background-color: #dc3545;
        color: white;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .mapa-sala {
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
        border-radius: 10px;
    }

    /* Estilo para as caixas de pagamento */
    .payment-option-card {
        cursor: pointer;
        transition: all 0.2s;
    }

        .payment-option-card:hover {
            background-color: #f8f9fa;
        }

        .payment-option-card.selected {
            border-color: #0d6efd !important;
            background-color: #e7f1ff !important;
        }
</style>

<h1>@(User.IsInRole("Cliente") ? "Comprar Ingresso" : "Vender Ingresso")</h1>
<hr />

<!-- Alerta de erro (se houver) -->
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger" id="alert-error">@TempData["Error"]</div>
}

<div class="row">
    <!-- COLUNA 1: Detalhes do Filme/Sessão -->
    <div class="col-md-4 mb-4">
        <h4>Detalhes da Sessão</h4>
        <div class="card shadow-sm bg-dark text-white border-secondary sticky-top" style="top: 100px; z-index: 1;">
            <img src="@Model.Session.Movie.PosterUrl" class="card-img-top" style="max-height: 400px; object-fit: cover;" />
            <div class="card-body">
                <h5 class="card-title text-danger">@Model.Session.Movie.Title</h5>
                <p class="card-text">
                    <strong><i class="bi bi-door-closed"></i> Sala:</strong> @Model.Session.Room.Name (@Model.Session.Room.Type) <br>
                    <strong><i class="bi bi-calendar-event"></i> Data:</strong> @Model.Session.ScheduledTime.ToString("dd/MM/yyyy") <br>
                    <strong><i class="bi bi-clock"></i> Horário:</strong> @Model.Session.ScheduledTime.ToString("HH:mm") <br>
                    <strong><i class="bi bi-cash"></i> Preço:</strong> <span class="text-success fs-5 fw-bold">@Model.Session.Price.ToString("C")</span> <br>
                    <strong><i class="bi bi-people"></i> Disponíveis:</strong> <span class="badge bg-success">@Model.Session.AvailableSeats</span>
                </p>
            </div>
        </div>
    </div>

    <!-- COLUNA 2: Seleção e Pagamento -->
    <div class="col-md-8">

        <!-- 1. MAPA DE ASSENTOS -->
        <h4>1. Selecione o Assento</h4>
        <div class="mapa-sala p-3 rounded text-center mb-4 shadow-sm">
            <div class="bg-dark text-white p-2 mb-3 rounded shadow-sm fw-bold d-inline-block w-75">TELA</div>
            <br />

            @for (int i = 1; i <= Model.Session.Room.SeatCount; i++)
            {
                bool isOcupado = Model.OccupiedSeats.Contains(i);

                <button type="button"
                        class="btn assento @(isOcupado ? "assento-ocupado disabled" : "btn-outline-primary btn-assento-livre")"
                        data-assento-numero="@i"
                        @Html.Raw(isOcupado ? "disabled" : "")>
                    @i
                </button>
            }

            <div class="mt-3 small">
                <span class="badge bg-primary me-2">Selecionado</span>
                <span class="badge bg-danger me-2">Ocupado</span>
                <span class="badge border text-dark bg-light">Livre</span>
            </div>
        </div>

        <!-- FORMULÁRIO PRINCIPAL -->
        <form asp-action="Purchase" method="post" class="p-4 bg-white rounded shadow-sm text-dark border">
            <input type="hidden" name="sessionId" value="@Model.Session.Id" />
            <input type="hidden" id="numeroAssentoInput" name="seatNumber" value="0" />

            <!-- 2. DADOS DO CLIENTE (SÓ APARECE PARA ADMIN/ATENDENTE) -->
            @if (User.IsInRole("Admin") || User.IsInRole("Atendente"))
            {
                <div class="mb-4 p-3 bg-light border rounded">
                    <h5 class="text-danger border-bottom pb-2 mb-3"><i class="bi bi-person-badge-fill"></i> Dados do Cliente (Venda Presencial)</h5>
                    <div class="row g-2">
                        <div class="col-md-8">
                            <label class="form-label small fw-bold">Nome do Cliente</label>
                            <input asp-for="CustomerName" class="form-control" placeholder="Nome (Opcional)" />
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">CPF</label>
                            <input asp-for="CustomerCPF" class="form-control" placeholder="000.000.000-00" />
                        </div>
                    </div>
                </div>
            }

          
            <div class="mb-4 p-3 bg-light border rounded">
                <h5 class="text-primary border-bottom pb-2 mb-3"><i class="bi bi-credit-card"></i> Forma de Pagamento</h5>

              
                <div class="d-flex gap-2 mb-3">

              
                    <div class="form-check border rounded p-3 flex-fill payment-option-card selected" onclick="selectPayment('card')">
                        <input class="form-check-input" type="radio" name="PaymentMethod" id="payCard" value="Cartão de Crédito" checked>
                        <label class="form-check-label w-100" for="payCard" style="cursor: pointer;">
                            <i class="bi bi-credit-card-2-front fs-4 d-block text-primary"></i>
                            <span class="fw-bold">Cartão</span>
                        </label>
                    </div>

              
                    <div class="form-check border rounded p-3 flex-fill payment-option-card" onclick="selectPayment('pix')">
                        <input class="form-check-input" type="radio" name="PaymentMethod" id="payPix" value="Pix">
                        <label class="form-check-label w-100" for="payPix" style="cursor: pointer;">
                            <i class="bi bi-qr-code-scan fs-4 d-block text-success"></i>
                            <span class="fw-bold">Pix</span>
                        </label>
                    </div>

                
                    @if (!User.IsInRole("Cliente"))
                    {
                        <div class="form-check border rounded p-3 flex-fill payment-option-card" onclick="selectPayment('cash')">
                            <input class="form-check-input" type="radio" name="PaymentMethod" id="payCash" value="Dinheiro">
                            <label class="form-check-label w-100" for="payCash" style="cursor: pointer;">
                                <i class="bi bi-cash-coin fs-4 d-block text-warning"></i>
                                <span class="fw-bold">Dinheiro</span>
                            </label>
                        </div>
                    }
                </div>

          
                <div id="card-info" class="alert alert-light border text-center mt-3">
                    <i class="bi bi-lock-fill"></i> Seus dados de cartão salvos serão utilizados.
                </div>

                <div id="pix-info" class="alert alert-success text-center d-none mt-3">
                    <i class="bi bi-qr-code fs-1"></i><br>
                    O QR Code Pix será gerado na tela de confirmação.
                </div>

                <div id="cash-info" class="alert alert-warning text-center d-none mt-3">
                    <i class="bi bi-cash-coin fs-1"></i><br>
                    Receba o valor no caixa.
                </div>
            </div>

    
            <div class="d-flex justify-content-between align-items-center pt-3 border-top mt-2">
                <div>
                    <h4 class="mb-0">Assento: <span id="assentoSelecionadoDisplay" class="badge bg-secondary fs-5">Nenhum</span></h4>
                    <small class="text-muted fw-bold">Total: <span class="text-success fs-5">@Model.Session.Price.ToString("C")</span></small>
                </div>

                <button type="submit" id="btnConfirmarVenda" class="btn btn-success btn-lg px-4 shadow" disabled>
                    <i class="bi bi-check-circle-fill me-2"></i>
                    @if (User.IsInRole("Cliente"))
                    {
                        <span>Pagar e Confirmar</span>
                    }
                    else
                    {
                        <span>Finalizar Venda</span>
                    }
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
       
        function selectPayment(method) {
          
            let radioVal = '';
            if(method === 'card') radioVal = 'Cartão de Crédito';
            if(method === 'pix') radioVal = 'Pix';
            if(method === 'cash') radioVal = 'Dinheiro';

            const radio = document.querySelector(`input[name="PaymentMethod"][value="${radioVal}"]`);
            if(radio) radio.checked = true;

           
            document.querySelectorAll('.payment-option-card').forEach(el => el.classList.remove('selected'));
            if(radio) radio.closest('.payment-option-card').classList.add('selected');

  
            document.getElementById('card-info').classList.add('d-none');
            document.getElementById('pix-info').classList.add('d-none');
            const cashInfo = document.getElementById('cash-info');
            if(cashInfo) cashInfo.classList.add('d-none');

            if(method === 'card') document.getElementById('card-info').classList.remove('d-none');
            if(method === 'pix') document.getElementById('pix-info').classList.remove('d-none');
            if(method === 'cash' && cashInfo) cashInfo.classList.remove('d-none');
        }

        document.addEventListener("DOMContentLoaded", function() {
            const assentosLivres = document.querySelectorAll('.btn-assento-livre');
            const displayAssento = document.getElementById('assentoSelecionadoDisplay');
            const inputAssento = document.getElementById('numeroAssentoInput');
            const btnConfirmar = document.getElementById('btnConfirmarVenda');
            const alertError = document.getElementById('alert-error');

            let assentoSelecionado = 0;

            if(alertError) {
                setTimeout(() => { alertError.style.display = 'none'; }, 5000);
            }

            assentosLivres.forEach(btn => {
                btn.addEventListener('click', function() {
                   
                    assentosLivres.forEach(b => b.classList.remove('assento-selecionado'));

              
                    this.classList.add('assento-selecionado');
                    assentoSelecionado = this.dataset.assentoNumero;

                    displayAssento.textContent = assentoSelecionado;
                    displayAssento.classList.remove('bg-secondary');
                    displayAssento.classList.add('bg-primary');

                    inputAssento.value = assentoSelecionado;

                   
                    btnConfirmar.disabled = false;
                });
            });

           
            selectPayment('card');
        });
    </script>
}